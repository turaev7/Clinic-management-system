{% extends 'base.html' %}
{% block content %}
<h4 class="mb-3">
  {{ t('cleanup_invalid') if t('cleanup_invalid') != 'cleanup_invalid' else 'Patients with missing required fields' }}
</h4>
<p class="text-muted">
  {{ t('cleanup_intro') if t('cleanup_intro') != 'cleanup_intro' else
     'Select the rows you want to delete, or delete all listed patients created by a bad import.' }}
</p>

{% if rows and rows|length %}
<form method="post" id="cleanup-form">
  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:36px;">
            <input class="form-check-input" type="checkbox" id="sel-all" title="{{ t('select_all') if t('select_all') != 'select_all' else 'Select all' }}">
          </th>
          <th>{{ t('hist_number') }}</th>
          <th>{{ t('patient_full_name') if t('patient_full_name') != 'patient_full_name' else 'Full name' }}</th>
          <th>{{ t('missing_fields') if t('missing_fields') != 'missing_fields' else 'Missing fields' }}</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>
            <input class="form-check-input sel-row" type="checkbox" name="sel" value="{{ r.p.id }}">
          </td>
          <td>{{ r.p.hist_number or '—' }}</td>
          <td>{{ (r.p.last_name ~ ' ' ~ r.p.first_name ~ ' ' ~ r.p.patronymic)|trim }}</td>
          <td>{{ r.missing|join(', ') if r.missing and r.missing|length else '—' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-danger" name="delete_selected" value="1">
      {{ t('delete_selected') if t('delete_selected') != 'delete_selected' else 'Delete selected' }}
    </button>

    <button class="btn btn-outline-danger" name="delete_all" value="1"
            onclick="return confirm('{{ t('delete_all_listed') if t('delete_all_listed') != 'delete_all_listed' else 'Delete all listed?' }}');">
      {{ t('delete_all_listed') if t('delete_all_listed') != 'delete_all_listed' else 'Delete all listed' }}
    </button>

    <a class="btn btn-secondary ms-auto" href="{{ url_for('settings_home') }}">
      {{ t('back') if t('back') != 'back' else 'Back' }}
    </a>
  </div>
</form>

<script>
  // Simple "select all" toggle
  (function () {
    const selAll = document.getElementById('sel-all');
    if (!selAll) return;
    selAll.addEventListener('change', function () {
      document.querySelectorAll('.sel-row').forEach(cb => { cb.checked = selAll.checked; });
    });
  })();
</script>

{% else %}
<div class="alert alert-success">
  {{ t('no_invalid_records') if t('no_invalid_records') != 'no_invalid_records' else 'No invalid patients found.' }}
</div>
<a class="btn btn-secondary" href="{{ url_for('settings_home') }}">
  {{ t('back') if t('back') != 'back' else 'Back' }}
</a>
{% endif %}
{% endblock %}